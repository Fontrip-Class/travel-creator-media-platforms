# æ—…éŠå¹³å°è³‡æ–™åº«æ¶æ§‹ v5.0 ä¸€è‡´æ€§æª¢æŸ¥å ±å‘Š

## ğŸ“‹ æ¦‚è¿°

æœ¬å ±å‘Šè©³ç´°è¨˜éŒ„äº† v5.0 æ¶æ§‹çš„è®Šæ›´ï¼Œç¢ºä¿å‰ç«¯ã€å¾Œç«¯ã€è³‡æ–™åº«ä¸‰å€‹å±¤é¢çš„è³‡æ–™çµæ§‹ä¸€è‡´æ€§ã€‚ä¸»è¦è®Šæ›´åŒ…æ‹¬ï¼š

1. **æ¥­å‹™å¯¦é«”æ¬„ä½èª¿æ•´**ï¼šç¢ºä¿èˆ‡ä¾›æ‡‰å•†ã€å‰µä½œè€…ã€åª’é«”çš„æ¬„ä½éœ€æ±‚ä¸€è‡´
2. **æ¬Šé™ç³»çµ±ç°¡åŒ–**ï¼šå¾å››ç´šæ¬Šé™ç°¡åŒ–ç‚ºå…©ç´šï¼ˆç®¡ç†è€…å’Œä¸€èˆ¬ä½¿ç”¨è€…ï¼‰
3. **é¡å‹å®šç¾©æ›´æ–°**ï¼šæ›´æ–° TypeScript é¡å‹å®šç¾©ä»¥åæ˜ æ–°çš„è³‡æ–™åº«çµæ§‹
4. **API æœå‹™æ›´æ–°**ï¼šæ·»åŠ æ–°çš„æ¬Šé™æª¢æŸ¥æ–¹æ³•å’Œæ¥­å‹™å¯¦é«”ç®¡ç†ç«¯é»
5. **å¾Œç«¯æœå‹™å‰µå»º**ï¼šå¯¦ç¾æ–°çš„æ¬Šé™æª¢æŸ¥æœå‹™

## ğŸ”„ ä¸»è¦è®Šæ›´æ‘˜è¦

### 1. æ¥­å‹™å¯¦é«”è¡¨ (`business_entities`) æ¬„ä½èª¿æ•´

#### æ–°å¢æ¬„ä½
- `portfolio_url` (å‰µä½œè€…æª”æ¡ˆé€£çµ)
- `can_edit_profile` (ç·¨è¼¯åŸºæœ¬è³‡æ–™æ¬Šé™)

#### æ¬„ä½å°æ‡‰é—œä¿‚
| æ¥­å‹™é¡å‹ | å°æ‡‰çš„è©³ç´°è³‡è¨Šè¡¨ | ä¸»è¦æ¬„ä½ |
|----------|------------------|----------|
| `supplier` | `supplier_profiles` | company_name, business_type, license_number, service_areas |
| `koc` | `creator_profiles` | portfolio_url, content_types, target_audience, follower_count |
| `media` | `media_profiles` | media_type, platform_name, audience_size, content_categories |

### 2. æ¬Šé™ç³»çµ±ç°¡åŒ–

#### èˆŠæ¬Šé™ç­‰ç´š (v4)
- `owner` - æ“æœ‰è€…
- `admin` - ç®¡ç†å“¡  
- `manager` - ç¶“ç†
- `viewer` - æŸ¥çœ‹è€…

#### æ–°æ¬Šé™ç­‰ç´š (v5)
- `manager` - ç®¡ç†è€…ï¼ˆæ“æœ‰æ‰€æœ‰æ¬Šé™ï¼‰
- `user` - ä¸€èˆ¬ä½¿ç”¨è€…ï¼ˆæ ¹æ“šå…·é«”æ¬Šé™é…ç½®ï¼‰

#### æ¬Šé™ç¯„åœ
| æ¬Šé™ | manager | user (å¯é…ç½®) |
|------|---------|---------------|
| `can_manage_users` | âœ… | âš™ï¸ |
| `can_manage_content` | âœ… | âš™ï¸ |
| `can_manage_finance` | âœ… | âš™ï¸ |
| `can_view_analytics` | âœ… | âš™ï¸ |
| `can_edit_profile` | âœ… | âœ… (é è¨­) |

## ğŸ“ æ–‡ä»¶è®Šæ›´æ¸…å–®

### 1. è³‡æ–™åº«çµæ§‹æ–‡ä»¶
- âœ… `schema_v5_user_roles.sql` - æ›´æ–°æ¬Šé™ç­‰ç´šå’Œæ¥­å‹™å¯¦é«”æ¬„ä½
- âœ… `migrate_to_v5.php` - èª¿æ•´æ¬Šé™æ’å…¥é‚è¼¯

### 2. å‰ç«¯é¡å‹å®šç¾©
- âœ… `src/types/database.ts` - æ›´æ–°æ¬Šé™ç­‰ç´šå’Œæ¥­å‹™å¯¦é«”é¡å‹

### 3. å‰ç«¯ API æœå‹™
- âœ… `src/lib/api.ts` - æ·»åŠ æ¬Šé™æª¢æŸ¥æ–¹æ³•å’Œæ¥­å‹™å¯¦é«”ç®¡ç†ç«¯é»

### 4. å¾Œç«¯æœå‹™
- âœ… `backend/src/Services/PermissionService.php` - æ–°çš„æ¬Šé™æª¢æŸ¥æœå‹™

## ğŸ” ä¸€è‡´æ€§æª¢æŸ¥çµæœ

### 1. è³‡æ–™åº«æ¬„ä½ä¸€è‡´æ€§ âœ…

#### business_entities è¡¨
- åŸºæœ¬è³‡è¨Šæ¬„ä½ï¼šâœ… ä¸€è‡´
- è¯çµ¡è³‡è¨Šæ¬„ä½ï¼šâœ… ä¸€è‡´
- åœ°ç†ä½ç½®æ¬„ä½ï¼šâœ… ä¸€è‡´
- æ¥­å‹™ç›¸é—œæ¬„ä½ï¼šâœ… ä¸€è‡´
- ç¤¾äº¤åª’é«”æ¬„ä½ï¼šâœ… ä¸€è‡´
- ç‹€æ…‹æ¬„ä½ï¼šâœ… ä¸€è‡´
- å¯©è¨ˆæ¬„ä½ï¼šâœ… ä¸€è‡´

#### user_business_permissions è¡¨
- æ¬Šé™ç­‰ç´šï¼šâœ… ç°¡åŒ–ç‚º manager/user
- æ¬Šé™ç¯„åœï¼šâœ… èˆ‡ TypeScript é¡å‹ä¸€è‡´
- ç‹€æ…‹æ¬„ä½ï¼šâœ… ä¸€è‡´

### 2. TypeScript é¡å‹ä¸€è‡´æ€§ âœ…

#### æ¬Šé™ç›¸é—œé¡å‹
```typescript
// æ¬Šé™ç­‰ç´š
export type PermissionLevel = 'manager' | 'user';

// æ¬Šé™ä»‹é¢
export interface UserBusinessPermission {
  permission_level: PermissionLevel;
  can_manage_users: boolean;
  can_manage_content: boolean;
  can_manage_finance: boolean;
  can_view_analytics: boolean;
  can_edit_profile: boolean;
}
```

#### æ¥­å‹™å¯¦é«”é¡å‹
```typescript
// æ¥­å‹™å¯¦é«”ä»‹é¢
export interface BusinessEntity {
  id: UUID;
  name: string;
  business_type: BusinessType;
  // ... å…¶ä»–æ¬„ä½èˆ‡è³‡æ–™åº«ä¸€è‡´
}

// å‰µä½œè€…è©³ç´°è³‡è¨Š
export interface CreatorProfile {
  portfolio_url?: string; // æ–°å¢æ¬„ä½
  // ... å…¶ä»–æ¬„ä½
}
```

### 3. API ç«¯é»ä¸€è‡´æ€§ âœ…

#### æ¬Šé™æª¢æŸ¥ç«¯é»
```typescript
// æª¢æŸ¥æ¬Šé™
GET /api/permissions/check?user_id={userId}&business_entity_id={businessId}&permission={permission}

// ç²å–ç”¨æˆ¶æ¬Šé™ç­‰ç´š
GET /api/permissions/user-level?user_id={userId}&business_entity_id={businessId}
```

#### æ¥­å‹™å¯¦é«”ç®¡ç†ç«¯é»
```typescript
// æ¥­å‹™å¯¦é«” CRUD
GET /api/business-entities
POST /api/business-entities
PUT /api/business-entities/{id}
DELETE /api/business-entities/{id}

// æ¬Šé™ç®¡ç†
POST /api/user-business-permissions
PUT /api/user-business-permissions/{id}
DELETE /api/user-business-permissions/{id}
```

## ğŸš€ ä½¿ç”¨æ–¹å¼

### 1. åŸ·è¡Œè³‡æ–™åº«é·ç§»
```bash
cd backend/database
php migrate_to_v5.php
```

### 2. æ¬Šé™æª¢æŸ¥ä½¿ç”¨
```typescript
// æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å¯ä»¥ç®¡ç†å…§å®¹
const canManage = await api.checkBusinessEntityPermission(
  userId, 
  businessEntityId, 
  'manage_content'
);

// ç²å–ç”¨æˆ¶æ¬Šé™ç­‰ç´š
const userLevel = await api.getUserPermissionLevel(userId, businessEntityId);
```

### 3. æ¥­å‹™å¯¦é«”ç®¡ç†
```typescript
// å‰µå»ºæ¥­å‹™å¯¦é«”
const business = await api.createBusinessEntity({
  name: 'ä¹æ—æ–‡åŒ–æ‘',
  business_type: 'supplier',
  description: 'çŸ¥åä¸»é¡Œæ¨‚åœ’'
});

// åˆ†é…æ¬Šé™
const permission = await api.assignBusinessPermission({
  user_id: userId,
  business_entity_id: business.id,
  role_id: roleId,
  permission_level: 'manager'
});
```

## âš ï¸ æ³¨æ„äº‹é …

### 1. æ¬Šé™ç³»çµ±è®Šæ›´
- èˆŠçš„å››ç´šæ¬Šé™ç³»çµ±å·²ç°¡åŒ–ç‚ºå…©ç´š
- éœ€è¦æ›´æ–°ç¾æœ‰çš„æ¬Šé™æª¢æŸ¥é‚è¼¯
- å»ºè­°åœ¨é·ç§»å¾Œé‡æ–°åˆ†é…ç”¨æˆ¶æ¬Šé™

### 2. æ¥­å‹™å¯¦é«”æ¬„ä½
- æ–°å¢çš„ `portfolio_url` æ¬„ä½ä¸»è¦ç”¨æ–¼å‰µä½œè€…
- `can_edit_profile` æ¬Šé™é è¨­ç‚º trueï¼Œç¢ºä¿åŸºæœ¬åŠŸèƒ½å¯ç”¨

### 3. å‘å¾Œå…¼å®¹æ€§
- èˆŠçš„ API ç«¯é»ä»ç„¶å¯ç”¨
- æ–°çš„æ¬Šé™æª¢æŸ¥æ–¹æ³•æä¾›äº†æ›´ç´°ç·»çš„æ§åˆ¶
- å»ºè­°é€æ­¥é·ç§»åˆ°æ–°çš„æ¬Šé™ç³»çµ±

## ğŸ“Š æ¸¬è©¦å»ºè­°

### 1. æ¬Šé™æª¢æŸ¥æ¸¬è©¦
- æ¸¬è©¦ç®¡ç†è€…æ¬Šé™ï¼ˆæ‡‰æ“æœ‰æ‰€æœ‰æ¬Šé™ï¼‰
- æ¸¬è©¦ä¸€èˆ¬ä½¿ç”¨è€…æ¬Šé™ï¼ˆæ‡‰æ ¹æ“šé…ç½®é™åˆ¶ï¼‰
- æ¸¬è©¦æ¬Šé™é‚Šç•Œæƒ…æ³

### 2. æ¥­å‹™å¯¦é«”ç®¡ç†æ¸¬è©¦
- æ¸¬è©¦å‰µå»ºã€æ›´æ–°ã€åˆªé™¤æ¥­å‹™å¯¦é«”
- æ¸¬è©¦æ¬Šé™åˆ†é…å’Œç§»é™¤
- æ¸¬è©¦ä¸åŒæ¥­å‹™é¡å‹çš„æ¬„ä½é©—è­‰

### 3. å‰ç«¯æ•´åˆæ¸¬è©¦
- æ¸¬è©¦ TypeScript é¡å‹æª¢æŸ¥
- æ¸¬è©¦ API èª¿ç”¨
- æ¸¬è©¦æ¬Šé™ç›¸é—œçš„ UI é¡¯ç¤º

## ğŸ¯ å¾ŒçºŒå·¥ä½œ

### 1. çŸ­æœŸç›®æ¨™
- [ ] å®Œæˆå¾Œç«¯ API ç«¯é»å¯¦ç¾
- [ ] æ›´æ–°å‰ç«¯çµ„ä»¶ä»¥ä½¿ç”¨æ–°çš„æ¬Šé™ç³»çµ±
- [ ] é€²è¡Œå®Œæ•´çš„ç«¯åˆ°ç«¯æ¸¬è©¦

### 2. ä¸­æœŸç›®æ¨™
- [ ] å„ªåŒ–æ¬Šé™æª¢æŸ¥æ€§èƒ½
- [ ] æ·»åŠ æ¬Šé™è®Šæ›´å¯©è¨ˆæ—¥èªŒ
- [ ] å¯¦ç¾æ¬Šé™æ¨¡æ¿ç³»çµ±

### 3. é•·æœŸç›®æ¨™
- [ ] æ”¯æŒæ›´è¤‡é›œçš„æ¬Šé™è¦å‰‡
- [ ] å¯¦ç¾åŸºæ–¼è§’è‰²çš„æ¬Šé™ç¹¼æ‰¿
- [ ] æ·»åŠ æ¬Šé™åˆ†æå ±è¡¨

## ğŸ“ ç¸½çµ

v5.0 æ¶æ§‹é€šéä»¥ä¸‹æ–¹å¼ç¢ºä¿äº†å‰å¾Œå°è³‡æ–™åº«æ¬„ä½çš„ä¸€è‡´æ€§ï¼š

1. **çµ±ä¸€çš„è³‡æ–™çµæ§‹**ï¼šæ‰€æœ‰è¡¨çµæ§‹éƒ½ç¶“éä»”ç´°è¨­è¨ˆï¼Œç¢ºä¿æ¬„ä½åç¨±ã€é¡å‹å’Œç´„æŸä¸€è‡´
2. **é¡å‹å®‰å…¨**ï¼šTypeScript é¡å‹å®šç¾©èˆ‡è³‡æ–™åº«çµæ§‹å®Œå…¨å°æ‡‰
3. **API ä¸€è‡´æ€§**ï¼šå‰ç«¯ API æœå‹™èˆ‡å¾Œç«¯ç«¯é»ä¿æŒä¸€è‡´
4. **æ¬Šé™ç³»çµ±ç°¡åŒ–**ï¼šå¾è¤‡é›œçš„å››ç´šæ¬Šé™ç°¡åŒ–ç‚ºæ¸…æ™°çš„å…©ç´šæ¬Šé™
5. **å®Œæ•´çš„æ–‡æª”**ï¼šæä¾›è©³ç´°çš„é·ç§»æŒ‡å—å’Œä½¿ç”¨èªªæ˜

é€™ç¨®è¨­è¨ˆç¢ºä¿äº†ç³»çµ±çš„å¯ç¶­è­·æ€§ã€å¯æ“´å±•æ€§å’Œä¸€è‡´æ€§ï¼Œç‚ºæœªä¾†çš„åŠŸèƒ½æ“´å±•å¥ å®šäº†å …å¯¦çš„åŸºç¤ã€‚
