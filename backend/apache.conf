# 🚀 旅遊平台 Apache 生產環境配置
# 請根據實際環境修改以下配置

<VirtualHost *:80>
    ServerName your-domain.com
    ServerAlias www.your-domain.com
    DocumentRoot /var/www/travel-platform/backend/public
    
    # 重定向到HTTPS
    Redirect permanent / https://your-domain.com/
</VirtualHost>

<VirtualHost *:443>
    ServerName your-domain.com
    ServerAlias www.your-domain.com
    DocumentRoot /var/www/travel-platform/backend/public
    
    # SSL配置
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/your-domain.com/cert.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/your-domain.com/privkey.pem
    SSLCertificateChainFile /etc/letsencrypt/live/your-domain.com/chain.pem
    
    # SSL安全設置
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder on
    SSLCompression off
    
    # 安全標頭
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # 日誌配置
    ErrorLog ${APACHE_LOG_DIR}/travel-platform-error.log
    CustomLog ${APACHE_LOG_DIR}/travel-platform-access.log combined
    
    # 目錄配置
    <Directory /var/www/travel-platform/backend/public>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # 快取設置
        <IfModule mod_expires.c>
            ExpiresActive on
            ExpiresByType text/css "access plus 1 year"
            ExpiresByType application/javascript "access plus 1 year"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/jpg "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/gif "access plus 1 year"
            ExpiresByType image/ico "access plus 1 year"
            ExpiresByType image/svg+xml "access plus 1 year"
            ExpiresByType application/pdf "access plus 1 year"
        </IfModule>
        
        # Gzip壓縮
        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/plain
            AddOutputFilterByType DEFLATE text/html
            AddOutputFilterByType DEFLATE text/xml
            AddOutputFilterByType DEFLATE text/css
            AddOutputFilterByType DEFLATE application/xml
            AddOutputFilterByType DEFLATE application/xhtml+xml
            AddOutputFilterByType DEFLATE application/rss+xml
            AddOutputFilterByType DEFLATE application/javascript
            AddOutputFilterByType DEFLATE application/x-javascript
        </IfModule>
    </Directory>
    
    # 上傳目錄配置
    <Directory /var/www/travel-platform/backend/uploads>
        Options -Indexes
        AllowOverride None
        Require all granted
        
        # 快取設置
        <IfModule mod_expires.c>
            ExpiresActive on
            ExpiresByType image/* "access plus 1 year"
            ExpiresByType video/* "access plus 1 year"
            ExpiresByType application/pdf "access plus 1 year"
        </IfModule>
    </Directory>
    
    # 健康檢查
    <Location /health>
        SetHandler application/x-httpd-php
        Require all granted
    </Location>
    
    # 禁止訪問敏感文件
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
    
    <FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|conf)$">
        Require all denied
    </FilesMatch>
    
    # 客戶端配置
    LimitRequestBody 52428800
    Timeout 300
</VirtualHost>

# 前端應用配置（如果使用子域名）
<VirtualHost *:80>
    ServerName app.your-domain.com
    DocumentRoot /var/www/travel-platform/dist
    
    # 重定向到HTTPS
    Redirect permanent / https://app.your-domain.com/
</VirtualHost>

<VirtualHost *:443>
    ServerName app.your-domain.com
    DocumentRoot /var/www/travel-platform/dist
    
    # SSL配置
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/app.your-domain.com/cert.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/app.your-domain.com/privkey.pem
    SSLCertificateChainFile /etc/letsencrypt/live/app.your-domain.com/chain.pem
    
    # SSL安全設置
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder on
    SSLCompression off
    
    # 安全標頭
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # 日誌配置
    ErrorLog ${APACHE_LOG_DIR}/travel-platform-frontend-error.log
    CustomLog ${APACHE_LOG_DIR}/travel-platform-frontend-access.log combined
    
    # 目錄配置
    <Directory /var/www/travel-platform/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # 快取設置
        <IfModule mod_expires.c>
            ExpiresActive on
            ExpiresByType text/css "access plus 1 year"
            ExpiresByType application/javascript "access plus 1 year"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/jpg "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/gif "access plus 1 year"
            ExpiresByType image/ico "access plus 1 year"
            ExpiresByType image/svg+xml "access plus 1 year"
            ExpiresByType font/woff "access plus 1 year"
            ExpiresByType font/woff2 "access plus 1 year"
            ExpiresByType application/font-woff "access plus 1 year"
            ExpiresByType application/font-woff2 "access plus 1 year"
        </IfModule>
        
        # Gzip壓縮
        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/plain
            AddOutputFilterByType DEFLATE text/html
            AddOutputFilterByType DEFLATE text/xml
            AddOutputFilterByType DEFLATE text/css
            AddOutputFilterByType DEFLATE application/xml
            AddOutputFilterByType DEFLATE application/xhtml+xml
            AddOutputFilterByType DEFLATE application/rss+xml
            AddOutputFilterByType DEFLATE application/javascript
            AddOutputFilterByType DEFLATE application/x-javascript
        </IfModule>
        
        # 前端路由支持
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
    
    # 禁止訪問敏感文件
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
    
    <FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|conf)$">
        Require all denied
    </FilesMatch>
</VirtualHost>
